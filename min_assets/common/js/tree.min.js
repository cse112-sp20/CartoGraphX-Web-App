let directoryTree={},fileKeyToNameMap={},editorToFileKeyMap={};const DIRECTORY_TREE="/directory_trees/",TEAM_MAP="/team_maps/",CURRENT_EDITORS="/current_editors/",FILE="/files/",USER="/users/",SECONDS_PER_REFRESH=2;let intervalID,firstTreePrint=!0,editorsChanged=!1,directoryStructureChanged=!1,subscribedToDirectoryTreeChanges=!1,listeners=[],isCommandLineTest=!1;const createTree=(a,b,c)=>{dbAccess=b.database(),subscribeToChanges(TEAM_MAP,a,a=>{editorToFileKeyMap=a.val().current_editors,directoryTreeKey=a.val().rootFolder,editorsChanged=!0,subscribeToChanges(DIRECTORY_TREE,directoryTreeKey,async a=>{subscribedToDirectoryTreeChanges=!0,directoryTree=a.val(),directoryStructureChanged=!0,generateFileKeyToNameMap(),firstTreePrint&&(displayDirectoryTree(),firstTreePrint=!1,directoryStructureChanged=!1,editorsChanged=!1,intervalID=setInterval(()=>{(editorsChanged||directoryStructureChanged)&&(displayDirectoryTree(),editorsChanged=!1,directoryStructureChanged=!1)},1e3*SECONDS_PER_REFRESH),c&&c())})})},addListener=a=>{listeners.push(a)},alertListeners=()=>{listeners.forEach(a=>{a(fileKeyToNameMap)})},subscribeToChanges=(a,b,c)=>dbAccess.ref(a+b).on("value",c),generateFileKeyToNameMap=()=>{let a=[directoryTree];for(console.log("gen");0!=a.length;)for(let b in subDir=a.pop(),subDir)fileKeyToNameMap.hasOwnProperty(subDir[b])&&fileKeyToNameMap[subDir[b]]==b||("string"==typeof subDir[b]?fileKeyToNameMap[subDir[b]]=b.split(",").join("."):a.push(subDir[b]))},displayDirectoryTree=()=>{if(alertListeners(),str=generateSourceTree(directoryTree),!isCommandLineTest){const a=document.getElementById("tree");a.innerHTML=str}},generateSourceTree=a=>{let b="",c=!0;for(topLevelFile in a){const d=a[topLevelFile];"string"==typeof d?b+=topLevelFile+"\n":(c&&!isCommandLineTest&&(document.getElementById("tree-name").innerHTML=topLevelFile,c=!1),b+=topLevelFile+"\n",b+=generateSourceTreeRec(a[topLevelFile],""))}return b},generateSourceTreeRec=(a,b)=>{let c=[[" \u251C\u2500 "," \u2502  "],[" \u2514\u2500 ","    "]],d=Object.entries(Object.entries(a)),e="";for(const[f,[g,h]]of d){let a;a=isLastElementInArray(d,f)?c[1]:c[0],"string"==typeof h?e+=b+a[0]+fileKeyToNameMap[h]+" "+listEditorsOf(h)+"\n":(e+=b+a[0]+g.split(",").join(".")+"\n",e+=generateSourceTreeRec(h,b+a[1]))}return e},listEditorsOf=a=>{let b="(",c=!1;for(let d in editorToFileKeyMap)editorToFileKeyMap[d]==a&&(b+=colorText(d,"blue")+", ",c=!0);return b+=")",c?b.substring(0,b.length-3)+")":""},colorText=(a,b)=>"<span style=\"color:"+b+"\">"+a+"</span>",isLastElementInArray=(a,b)=>0==a.length?b==a.length:b==a.length-1,setDirectoryStructure=a=>{console.log("Setting directory"),directoryTree=a},getDirectoryStructure=()=>directoryTree,getEditorToFileKeyMap=()=>editorToFileKeyMap,getFileKeyToNameMap=()=>fileKeyToNameMap,setEditorToFileKeyMap=a=>{editorToFileKeyMap=a},setCommandLineTest=()=>{isCommandLineTest=!0},cancelInterval=()=>{clearInterval(intervalID)};testObject={},testObject.setDirectoryTree=setDirectoryStructure,testObject.generateSourceTree=generateSourceTree,testObject.generateFileKeyToNameMap=generateFileKeyToNameMap,testObject.setEditorToFileKeyMap=setEditorToFileKeyMap,testObject.listEditorsOf=listEditorsOf,testObject.colorText=colorText,testObject.generateSourceTreeRec=generateSourceTreeRec,testObject.isLastElementInArray=isLastElementInArray,testObject.directoryTree=directoryTree,testObject.fileKeyToNameMap=fileKeyToNameMap,testObject.editorToFileKeyMap=editorToFileKeyMap,testObject.createTree=createTree,testObject.setCommandLineTest=setCommandLineTest,testObject.getDirectoryStructure=getDirectoryStructure,testObject.cancelInterval=cancelInterval,testObject.getEditorToFileKeyMap=getEditorToFileKeyMap,testObject.getFileKeyToNameMap=getFileKeyToNameMap;